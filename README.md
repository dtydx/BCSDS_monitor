# bcsds_monitor
## 监控项脚本编写

**该脚本主要实现了对集群状态和当前节点的监控，对异常状态发送邮件告警并使用多线程定时任务。**

文件包含：

- **alarm_sign.py：**获取本机基础信息，使用静态类获取包括IP地址，时间，主机名，全局警告标记等。
- **menu.py：**监控项菜单。
- **Multithreading.py：**负责创建多线程定时监控任务。
- **send_email.py：**负责监控告警邮件发送；
- **cat_ceph_status.py**：负责监控集群信息，包括集群健康状态，osd节点使用率，osd节点状态，osd延迟信息，pg状态，mon节点状态，集群磁盘使用率等等。
- **cat_onenode.py：**负责监控当前节点状态，包括系统磁盘状态，内存状态，系统负载，CPU状态等等。

#### 脚本设计

通过监控集群状态和当前本机状态，创建多线程并设置定时监控任务，每30s运行一次获取一次监控项的值，如果监控项有异常，就发送邮件报警。

##### cat_ceph_status.py脚本设计

1. 监控集群状态，当集群状态不为HEALTH_OK时触发邮件告警，并返回具体异常信息。

2. 监控OSD节点的使用率，当节点使用率过高时触发邮件告警，并返回具体节点信息。
3. 监控OSD状态，当存在节点宕机时触发邮件告警，并返回具体节点信息。
4. 监控OSD延迟信息，当有节点延迟较长时触发邮件警告，并提升具体节点信息。
5. 监控放置组PG状态，当状态不为active+clean时触发邮件告警，并返回具体状态。
6. 监控mon状态，当状态不为leader或peon时触发邮件告警
7. 监控当前集群所有磁盘使用率，当超过设定阈值时触发告警。并返回具体节点信息。
8. 监控可视化管理界面是否正常运行，查看数据库连接，sdsom-rcm服务，crond服务是否正常。（待实现）

**cat_onenode.py脚本设计**

1. 监控当前节点所有磁盘设备，并统计磁盘使用情况，当超过阈值时触发邮件告警。
2. 监控当前节点系统内存和交换内存使用情况，当超过阈值时触发邮件告警。
3. 监控当前节点系统负载情况，当超过阈值时触发邮件告警。
4. 监控当前节点系统CPU使用率，当超过阈值时触发邮件告警。

**实现情况**

可以通过menu.py调用每个监控脚本实现情况；

测试多线程监控情况：

![image-20200917152223833](C:\Users\daixi\AppData\Roaming\Typora\typora-user-images\image-20200917152223833.png)

测试邮件发送功能，通过降低阈值获取监控告警邮件。

![image-20200918144520110](C:\Users\daixi\AppData\Roaming\Typora\typora-user-images\image-20200918144520110.png)
